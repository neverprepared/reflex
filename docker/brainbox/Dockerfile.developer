FROM brainbox-base

# =============================================================================
# Developer container — general development with read-only HTTP guardrail
# =============================================================================
LABEL brainbox.role=developer

# Claude config + network guardrail hook
COPY --chown=developer:developer docker/brainbox/setup/CLAUDE.md /home/developer/.claude/CLAUDE.md
COPY --chown=developer:developer docker/brainbox/setup/settings.json /home/developer/.claude/settings.json
COPY --chown=developer:developer docker/brainbox/setup/network-guardrail.py /home/developer/.claude/hooks/network-guardrail.py

# Skills — Infrastructure / Cloud
COPY --chown=developer:developer reflex/plugins/reflex/skills/aws-patterns/SKILL.md /home/developer/.claude/skills/aws-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/azure-resource-discovery/SKILL.md /home/developer/.claude/skills/azure-resource-discovery/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/terraform-patterns/SKILL.md /home/developer/.claude/skills/terraform-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/kubernetes-patterns/SKILL.md /home/developer/.claude/skills/kubernetes-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/docker-patterns/SKILL.md /home/developer/.claude/skills/docker-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/observability-patterns/SKILL.md /home/developer/.claude/skills/observability-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/database-migration-patterns/SKILL.md /home/developer/.claude/skills/database-migration-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/n8n-patterns/SKILL.md /home/developer/.claude/skills/n8n-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/qdrant-patterns/SKILL.md /home/developer/.claude/skills/qdrant-patterns/SKILL.md

# Skills — Development
COPY --chown=developer:developer reflex/plugins/reflex/skills/agent-builder/SKILL.md /home/developer/.claude/skills/agent-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/workflow-builder/SKILL.md /home/developer/.claude/skills/workflow-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/router-builder/SKILL.md /home/developer/.claude/skills/router-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/mcp-server-builder/SKILL.md /home/developer/.claude/skills/mcp-server-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/workspace-builder/SKILL.md /home/developer/.claude/skills/workspace-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/project-onboarding/SKILL.md /home/developer/.claude/skills/project-onboarding/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/task-decomposition/SKILL.md /home/developer/.claude/skills/task-decomposition/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/analysis-patterns/SKILL.md /home/developer/.claude/skills/analysis-patterns/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/rag-builder/SKILL.md /home/developer/.claude/skills/rag-builder/SKILL.md
COPY --chown=developer:developer reflex/plugins/reflex/skills/rag-wrapper/SKILL.md /home/developer/.claude/skills/rag-wrapper/SKILL.md

# MCP servers
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add playwright -- npx @playwright/mcp --headless --browser chromium --no-sandbox'
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add memory -- npx -y @modelcontextprotocol/server-memory'
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add filesystem -- npx -y @modelcontextprotocol/server-filesystem /home/developer/workspace'
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add github -- npx -y @modelcontextprotocol/server-github'
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add brave-search -- npx -y @anthropic-ai/mcp-brave-search'
RUN bash -c '. "$NVM_DIR/nvm.sh" && claude mcp add qdrant -- uvx --python 3.12 --with fastembed mcp-server-qdrant'

# Skip onboarding
RUN bash -c 'if [ -f /home/developer/.claude.json ]; then \
    jq ". + {hasCompletedOnboarding: true, bypassPermissionsModeAccepted: true}" /home/developer/.claude.json > /tmp/.claude.json.tmp && \
    mv /tmp/.claude.json.tmp /home/developer/.claude.json; \
    else echo "{\"hasCompletedOnboarding\":true,\"bypassPermissionsModeAccepted\":true}" > /home/developer/.claude.json; fi'

# Shell config + ttyd wrapper
COPY --chown=developer:developer docker/brainbox/setup/.bashrc /tmp/.bashrc.extra
RUN cat /tmp/.bashrc.extra >> /home/developer/.bashrc && rm /tmp/.bashrc.extra

COPY --chown=developer:developer docker/brainbox/setup/ttyd-wrapper.sh /home/developer/ttyd-wrapper.sh
RUN chmod +x /home/developer/ttyd-wrapper.sh

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD pgrep -x "claude" > /dev/null || exit 1

CMD ["/bin/bash", "-l"]
